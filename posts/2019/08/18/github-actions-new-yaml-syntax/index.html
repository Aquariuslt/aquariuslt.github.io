<!DOCTYPE html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><!--[if IE]><link rel="icon" href="/favicon.ico" /><![endif]--><title>Github Actions: New YAML Syntax | Aquariuslt Blog</title><link href="/css/about.f196d9fa.css" rel="prefetch"><link href="/css/detail.550d548d.css" rel="prefetch"><link href="/js/about.c7f39767.js" rel="prefetch"><link href="/js/detail.0ea8bb28.js" rel="prefetch"><link href="/css/app.2d6b9bb1.css" rel="preload" as="style"><link href="/css/chunk-vendors.9bb7e852.css" rel="preload" as="style"><link href="/js/app.13ac62a3.js" rel="preload" as="script"><link href="/js/chunk-vendors.948d257a.js" rel="preload" as="script"><link href="/css/chunk-vendors.9bb7e852.css" rel="stylesheet"><link href="/css/app.2d6b9bb1.css" rel="stylesheet"><link rel="icon" type="image/png" sizes="32x32" href="/img/icons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/icons/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#1A73E8"><meta name="apple-mobile-web-app-capable" content="no"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="apple-mobile-web-app-title" content="Aquariuslt Blog"><link rel="apple-touch-icon" href="/img/icons/apple-touch-icon-152x152.png"><link rel="mask-icon" href="/img/icons/safari-pinned-tab.svg" color="#1A73E8"><meta name="msapplication-TileImage" content="/img/icons/msapplication-icon-144x144.png"><meta name="msapplication-TileColor" content="#000000"><link rel="stylesheet" type="text/css" href="/css/detail.550d548d.css"><script charset="utf-8" src="/js/detail.0ea8bb28.js"></script><meta data-vue-meta="1" name="og:site_name" content="Aquariuslt Blog"><meta data-vue-meta="1" name="og:type" content="website"><meta data-vue-meta="1" name="og:title" content="Github Actions: New YAML Syntax"><meta data-vue-meta="1" name="og:description" content="在之前一篇博文里刚介绍完 Github Actions 配置的HCL语法不久，Github 官方就标记为 deprecated 了。原因是社区声音推崇他们使用新的 YAML 语法，这类的语法配置与现有的其他 CI 平台相对更加接近，更加容易举一反三写出合理的配置。
"><meta data-vue-meta="1" name="og:image" content="./migrating-github-actions.png"><meta data-vue-meta="1" name="og:type" content="article"><script data-vue-meta="1" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://blog.aquariuslt.com","name":"Aquariuslt Blog","position":1},{"@type":"ListItem","item":"https://blog.aquariuslt.com/posts","name":"Posts","position":2},{"@type":"ListItem","item":"https://blog.aquariuslt.com/posts/2019/08/18/github-actions-new-yaml-syntax","name":"Github Actions: New YAML Syntax","position":3}]}</script><script id="embed-disqus" data-timestamp="1571674760182" type="text/javascript" async="" src="//aquariuslt.disqus.com/embed.js"></script><link rel="prefetch" as="style" href="https://c.disquscdn.com/next/embed/styles/lounge.953a2bd009935f47a8e815c3ee2bfc5a.css"><link rel="prefetch" as="script" href="https://c.disquscdn.com/next/embed/common.bundle.bdf2715fe3d262793670748c6697b1f3.js"><link rel="prefetch" as="script" href="https://c.disquscdn.com/next/embed/lounge.bundle.df4113f81691d4ed6cccc5b74c6c17e8.js"><link rel="prefetch" as="script" href="https://disqus.com/next/config.js"><script src="https://c.disquscdn.com/next/embed/alfalfalfa.0823c767a3bc925f628afd9bed26c958.js" async="" charset="UTF-8"></script></head><body><div data-v-18dadf06="" id="app"><div data-v-18dadf06="" class="md-app md-app-side-drawer md-layout-row md-waterfall md-fixed md-theme-default"><div data-v-18dadf06="" class="md-drawer md-app-drawer md-theme-default md-left md-temporary"><div data-v-ac1b82fe="" data-v-18dadf06="" class="profile"><div data-v-ac1b82fe="" class="md-card md-theme-default"><div data-v-ac1b82fe="" class="md-card-header"><div data-v-ac1b82fe="" class="md-avatar md-theme-default"><img data-v-ac1b82fe="" src="https://img.aquariuslt.com/social/avator.png" alt="Avatar"></div><div data-v-ac1b82fe="" class="md-title">Aquariuslt</div><div data-v-ac1b82fe="" class="md-subhead">superaquariuslt@gmail.com</div></div></div></div><ul data-v-18dadf06="" class="md-list md-theme-default"><li data-v-18dadf06="" to="/" exact="" class="md-list-item"><a data-v-18dadf06="" href="/" class="md-list-item-router md-list-item-container md-button-clean" mdripple="true"><div class="md-list-item-content md-ripple"><i data-v-18dadf06="" class="mdi mdi-24px mdi-home"></i><span data-v-18dadf06="" class="md-list-item-text">Home</span> </div></a></li><li data-v-18dadf06="" to="/categories" exact="" class="md-list-item"><a data-v-18dadf06="" href="/categories" class="md-list-item-router md-list-item-container md-button-clean" mdripple="true"><div class="md-list-item-content md-ripple"><i data-v-18dadf06="" class="mdi mdi-24px mdi-shape"></i><span data-v-18dadf06="" class="md-list-item-text">Categories</span> </div></a></li><li data-v-18dadf06="" to="/tags" exact="" class="md-list-item"><a data-v-18dadf06="" href="/tags" class="md-list-item-router md-list-item-container md-button-clean" mdripple="true"><div class="md-list-item-content md-ripple"><i data-v-18dadf06="" class="mdi mdi-24px mdi-bookmark"></i><span data-v-18dadf06="" class="md-list-item-text">Tags</span> </div></a></li></ul> </div>  <main class="md-app-container md-flex md-layout-column md-theme-default md-scrollbar" style="padding-left: 0px;"><div data-v-18dadf06="" class="md-toolbar md-app-toolbar md-primary md-theme-default md-elevation-2 md-no-elevation" md-elevation="2" style="top: 0px;"><div data-v-18dadf06="" class="md-toolbar-row"><button data-v-18dadf06="" type="button" class="md-button md-icon-button md-theme-default" aria-label="menu"><div class="md-ripple"><div class="md-button-content"><i data-v-18dadf06="" class="mdi mdi-24px mdi-menu"></i></div> </div></button><span data-v-18dadf06="" class="md-title app-title">Github Actions: New YAML Syntax | Aquariuslt Blog</span></div></div> <div class="md-app-scroller md-layout-column md-flex md-theme-default md-scrollbar"><div data-v-18dadf06="" class="md-content md-app-content md-flex md-theme-default"><div data-v-590589f6="" data-v-18dadf06="" class="detail md-layout md-gutter md-alignment-top-center"><div data-v-46cb6cfe="" data-v-590589f6="" class="md-layout md-gutter md-alignment-top-center md-layout-item md-size-100"><div data-v-46cb6cfe="" class="breadcrumbs"><span data-v-46cb6cfe=""><a data-v-46cb6cfe="" href="/" class="breadcrumbs-item"> Aquariuslt Blog</a><span data-v-46cb6cfe="">&gt;</span></span><span data-v-46cb6cfe=""><a data-v-46cb6cfe="" href="/posts" class="breadcrumbs-item"> Posts</a><span data-v-46cb6cfe="">&gt;</span></span><span data-v-46cb6cfe=""><a data-v-46cb6cfe="" href="/posts/2019/08/18/github-actions-new-yaml-syntax" class="breadcrumbs-item router-link-exact-active router-link-active"> Github Actions: New YAML Syntax</a><!----></span></div></div><div data-v-48e13d92="" data-v-590589f6="" class="md-layout md-gutter md-alignment-top-center md-layout-item md-size-100"><div data-v-48e13d92="" class="md-card article-detail md-theme-default"><div data-v-48e13d92="" class="md-card-media article-cover"><img data-v-48e13d92="" src="/posts/2019/08/18/github-actions-new-yaml-syntax/migrating-github-actions.png" alt="cover"></div><div data-v-48e13d92="" class="md-card-content markdown-body"><h1>Github Actions: New YAML Syntax</h1>
<h2>Background</h2>
<p>在之前一篇博文里刚介绍完 Github Actions 配置的<code>HCL</code>语法不久，Github 官方就标记为 <strong>deprecated</strong> 了。原因是社区声音推崇他们使用新的 YAML 语法，这类的语法配置与现有的其他 CI 平台相对更加接近，更加容易举一反三写出合理的配置。</p>
<blockquote>
<p>The documentation at <a class="vglnk" href="https://developer.github.com/actions" rel="nofollow"><span>https</span><span>://</span><span>developer</span><span>.</span><span>github</span><span>.</span><span>com</span><span>/</span><span>actions</span></a> and support for the HCL syntax in GitHub Actions will be deprecated on September 30, 2019. Documentation for the new limited public beta using the YAML syntax is available on <a class="vglnk" href="https://help.github.com" rel="nofollow"><span>https</span><span>://</span><span>help</span><span>.</span><span>github</span><span>.</span><span>com</span></a>. See "Automating your workflow with GitHub Actions" for documentation using the YAML syntax.</p>
</blockquote>
<p>自此之后，官方的 Github Actions Marketplace 也多了更多的官方 Actions (actions 官方 org 原本置顶的几个 actions 源代码也都换成了常见的项目集成 samples)</p>
<p>话不多说，就着本次 Github Actions Syntax Migration，还是以上次的 <code>jest-properties-loader</code> 为例子，我将它用 typescript 进行重写，并且把 workflow 以同样的思路，迁移到 <code>YAML</code> 语法版本。具体的语法不阐述了，基本是所谓的 <strong>所见即所得</strong> 理解模式。</p>
<h2>Comparison</h2>
<p>既然是官方提倡的 Migration，Github 提供了很多帮助文档，来帮助你进行迁移。</p>
<p>最后的 <a href="#references">References</a> 部分，会给出一些官方提及的参考链接，但在这里更想直观的提及的是这次 Migration 前后的几个重要对比。</p>
<ul>
<li>在 Github Repo 的设置界面，原本的图形化修改 workflow 文件已经失效，直接变成一个 YAML 文件的在线编辑模式</li>
<li>默认的 workflow 默认路径，从 <code>.github/*.workflow</code> 变成了 <code>.github/workflows/*.yml</code></li>
<li>对应每一个 Step 的构建日志，都添加了基础的高亮功能，在也不是默认的 <code>stdout | tee</code> 的形式了</li>
<li>给人的感觉是启动速度超快，以前触发一次 Actions 从对应的构建环境容器拉取、启动，都花了不少时间，现在基本对标其他 CI 平台的链路完成速度</li>
<li>元数据支持方面，多了很多可选的选项，可以在 YAML 配置里编写很多类似注释级别的 <code>metadata</code></li>
<li>通过模板语法支持 <code>matrix build</code></li>
</ul>
<p><img src="/posts/2019/08/18/github-actions-new-yaml-syntax/build-log-highlight-support.png" alt="Build Log Highlight"></p>
<h2>Migrations</h2>
<p>下面这里是我个人对 <code>jest-properties-loader</code> 在使用 TypeScript 重写后的的迁移过程。</p>
<h3>Step 0: Migration Solution</h3>
<p>我直接放弃了官方的一些迁移手段: 比如先把官方一个迁移工具 clone 到本地，紧接着执行里面的脚本，将对应的 <code>.workflow</code> 文件转化成新的 Yaml 文件。</p>
<p>根据迁移后的实际流程，然后找官方提供的 Example 进行魔改。</p>
<p>目前来说，<code>jest-properties-loader</code> 作为一款 NPM Package，触发 CI/CD 的流程大致如下:</p>
<ol>
<li>平时提交代码，通过 CI 平台执行 <code>yarn test</code>, <code>yarn build</code>, 上传覆盖率报告到 <strong>Codecov</strong></li>
<li>触发 <code>release</code> 事件时，通过 CI 平台执行 <code>yarn build</code>，之后发布到 <code>npm registry</code> 上</li>
</ol>
<h3>Step 1: Copy Official Node-CI Example</h3>
<p>在确立了流程后，我们可以从任意 Repo 的 <code>Actions</code> 标签页，选择一些对应语言/平台的 <code>example workflow</code> 进行魔改。</p>
<p><img src="/posts/2019/08/18/github-actions-new-yaml-syntax/select-sample-workflow-for-npm.png" alt="Select NPM Example Workflow"></p>
<p>把官方的 <code>Node-CI</code> 直接应用到项目本身，也完全 OK。自此，我们第一步，通过 CI 平台执行<code>yarn test</code>,<code>yarn build</code>的功能就完成了。</p>
<pre><code class="hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Node</span> <span class="hljs-string">CI</span>

<span class="hljs-attr">on:</span> <span class="hljs-string">[push]</span>

<span class="hljs-attr">jobs:</span>
<span class="hljs-attr">  build:</span>
<span class="hljs-attr">    runs-on:</span> <span class="hljs-string">ubuntu-latest</span>

<span class="hljs-attr">    strategy:</span>
<span class="hljs-attr">      matrix:</span>
<span class="hljs-attr">        node-version:</span> <span class="hljs-string">[8.x,</span> <span class="hljs-number">10.</span><span class="hljs-string">x,</span> <span class="hljs-number">12.</span><span class="hljs-string">x]</span>

<span class="hljs-attr">    steps:</span>
<span class="hljs-attr">      - uses:</span> <span class="hljs-string">actions/checkout@v1</span>
<span class="hljs-attr">      - name:</span> <span class="hljs-string">Use</span> <span class="hljs-string">Node.js</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.node-version</span> <span class="hljs-string">}}</span>
<span class="hljs-attr">        uses:</span> <span class="hljs-string">actions/setup-node@v1</span>
<span class="hljs-attr">        with:</span>
<span class="hljs-attr">          node-version:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.node-version</span> <span class="hljs-string">}}</span>
<span class="hljs-attr">      - name:</span> <span class="hljs-string">npm</span> <span class="hljs-string">install,</span> <span class="hljs-string">build,</span> <span class="hljs-string">and</span> <span class="hljs-string">test</span>
<span class="hljs-attr">        run:</span> <span class="hljs-string">|
          npm install
          npm run build --if-present
          npm test
</span></code></pre>
<h3>Step 2: Upload coverage report to Codecov</h3>
<p>上传通用的 <code>lcov.info</code> 覆盖率报告文件到 CodeCov， 这一步也从之前的野生第三方 actions 切换到官方的 actions。</p>
<p>如下图，我们使用 新的 <code>${{secrets.CODECOV_TOKEN}}</code> 来获取 repo secrets 中的对应变量</p>
<pre><code class="hljs yaml"><span class="hljs-attr">- name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">coverage</span> <span class="hljs-string">to</span> <span class="hljs-string">Codecov</span>
<span class="hljs-attr">  uses:</span> <span class="hljs-string">codecov/codecov-action@v1.0.0</span>
<span class="hljs-attr">  with:</span>
<span class="hljs-attr">    token:</span> <span class="hljs-string">${{secrets.CODECOV_TOKEN}}</span>
<span class="hljs-attr">    file:</span> <span class="hljs-string">./reports/coverage/lcov.info</span>
<span class="hljs-attr">    flags:</span> <span class="hljs-string">unittests</span>
<span class="hljs-attr">    name:</span> <span class="hljs-string">codecov-umbrella</span>
</code></pre>
<h3>Step 3: Trigger Build Step with Condition (Release)</h3>
<p>在进行发布时，按照上篇博文的 <strong>创建 Release 触发新的 Workflow</strong> 的思路，原本的<code>HCL</code>配置应该这么写:</p>
<p><strong>Before:</strong></p>
<pre><code class="hljs hcl">workflow "release" {
  on = "release"
  resolves = ["npm:release"]
}

action "filter:release" {
  uses = "actions/bin/filter@master"
  args = "action created*"
}


action "npm:release" {
  needs = "filter:release"
  uses = "actions/npm@master"
  secrets = ["NPM_AUTH_TOKEN"]
  args = "publish"
}
</code></pre>
<p><strong>After:</strong></p>
<pre><code class="hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Publish</span> <span class="hljs-string">to</span> <span class="hljs-string">NPM</span>

<span class="hljs-attr">on:</span>
<span class="hljs-attr">  release:</span>
<span class="hljs-attr">    branches:</span>
<span class="hljs-bullet">      -</span> <span class="hljs-string">master</span>

<span class="hljs-attr">jobs:</span>
<span class="hljs-attr">  build:</span>
<span class="hljs-attr">    runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
<span class="hljs-attr">    steps:</span>
<span class="hljs-attr">      - uses:</span> <span class="hljs-string">actions/checkout@v1</span>
<span class="hljs-attr">      - uses:</span> <span class="hljs-string">actions/setup-node@v1</span>
<span class="hljs-attr">        with:</span>
<span class="hljs-attr">          node-version:</span> <span class="hljs-number">10</span>
<span class="hljs-attr">      - run:</span> <span class="hljs-string">|
          yarn install
          yarn test
          yarn build

</span><span class="hljs-attr">  publish-npm:</span>
<span class="hljs-attr">    needs:</span> <span class="hljs-string">build</span>
<span class="hljs-attr">    runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
<span class="hljs-attr">    steps:</span>
<span class="hljs-attr">      - uses:</span> <span class="hljs-string">actions/checkout@v1</span>
<span class="hljs-attr">      - uses:</span> <span class="hljs-string">actions/setup-node@v1</span>
<span class="hljs-attr">        with:</span>
<span class="hljs-attr">          node-version:</span> <span class="hljs-number">10</span>
<span class="hljs-attr">          registry-url:</span> <span class="hljs-attr"><a class="vglnk" href="https://registry.npmjs.org/" rel="nofollow"><span>https</span><span>://</span><span>registry</span><span>.</span><span>npmjs</span><span>.</span><span>org</span><span>/</span></a></span>
<span class="hljs-attr">      - run:</span> <span class="hljs-string">|
          yarn install
          yarn test
          yarn build
</span><span class="hljs-attr">      - run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">publish</span>
<span class="hljs-attr">        if:</span> <span class="hljs-string">github.event.action</span> <span class="hljs-string">==</span> <span class="hljs-string">'created'</span>
<span class="hljs-attr">        env:</span>
<span class="hljs-attr">          NODE_AUTH_TOKEN:</span> <span class="hljs-string">${{secrets.NPM_AUTH_TOKEN}}</span>
</code></pre>
<p>还是原汁原味的读取 <code>NPM_AUTH_TOKEN</code> secrets 变量, 使用 <code>if</code> 条件表达式代替原来的 <code>bin/filter</code> + <code>args</code> 条件表达式。</p>
<p>即可完整地代替原本的 HCL 语法 Workflow 。</p>
<h2>References</h2>
<ul>
<li><a href="https://help.github.com/en/articles/migrating-github-actions-from-hcl-syntax-to-yaml-syntax">Migrating GitHub Actions from HCL syntax to YAML syntax</a></li>
<li><a href="https://help.github.com/en/categories/automating-your-workflow-with-github-actions">Automating your workflow with GitHub Actions</a></li>
</ul>
</div><div data-v-48e13d92="" class="md-card-content"><div data-v-15189bc8="" data-v-48e13d92="" tabindex="0" class="md-chip md-theme-default md-clickable"><div class="md-ripple"><span data-v-15189bc8="" class=""> NPM </span> </div> <!----></div><div data-v-15189bc8="" data-v-48e13d92="" tabindex="0" class="md-chip md-theme-default md-clickable"><div class="md-ripple"><span data-v-15189bc8="" class=""> CI </span> </div> <!----></div><div data-v-15189bc8="" data-v-48e13d92="" tabindex="0" class="md-chip md-theme-default md-clickable"><div class="md-ripple"><span data-v-15189bc8="" class=""> Github </span> </div> <!----></div><div data-v-15189bc8="" data-v-48e13d92="" tabindex="0" class="md-chip md-theme-default md-clickable"><div class="md-ripple"><span data-v-15189bc8="" class=""> TravisCI </span> </div> <!----></div><div data-v-15189bc8="" data-v-48e13d92="" tabindex="0" class="md-chip md-theme-default md-clickable"><div class="md-ripple"><span data-v-15189bc8="" class=""> Actions </span> </div> <!----></div><div data-v-15189bc8="" data-v-48e13d92="" tabindex="0" class="md-chip md-theme-default md-clickable"><div class="md-ripple"><span data-v-15189bc8="" class=""> Docker </span> </div> <!----></div></div><div data-v-48e13d92="" class="md-card-content"><div data-v-7fa946ff="" data-v-48e13d92="" class="comment"><div data-v-7fa946ff="" id="disqus_thread"><iframe id="dsq-app7440" name="dsq-app7440" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="https://disqus.com/embed/comments/?base=default&amp;f=aquariuslt&amp;t_i=-posts-2019-08-18-github-actions-new-yaml-syntax&amp;t_u=https%3A%2F%2Fblog.aquariuslt.com%2Fposts%2F2019%2F08%2F18%2Fgithub-actions-new-yaml-syntax&amp;t_d=Github%20Actions%3A%20New%20YAML%20Syntax&amp;t_t=Github%20Actions%3A%20New%20YAML%20Syntax&amp;s_o=default#version=f274d4b819b5f36115bcd7094ebe0b59" style="width: 1px !important; min-width: 100% !important; border: none !important; overflow: hidden !important; height: 395px !important;" horizontalscrolling="no" verticalscrolling="no"></iframe></div></div></div></div></div></div></div></div></main> <!----></div></div><script src="/service-worker.js"></script><script type="text/javascript" src="/js/chunk-vendors.948d257a.js"></script><script type="text/javascript" src="/js/app.13ac62a3.js"></script><iframe style="display: none;"></iframe></body>