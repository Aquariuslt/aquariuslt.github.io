<head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><!--[if IE]><link rel="icon" href="/favicon.ico" /><![endif]--><title>Spring 整合 Apache Shiro 实现各等级的权限管理 | Aquariuslt Blog</title><link href="/css/about.f196d9fa.css" rel="prefetch"><link href="/css/detail.550d548d.css" rel="prefetch"><link href="/js/about.e6f20274.js" rel="prefetch"><link href="/js/detail.6094b501.js" rel="prefetch"><link href="/css/app.2d6b9bb1.css" rel="preload" as="style"><link href="/css/chunk-vendors.a179896c.css" rel="preload" as="style"><link href="/js/app.15b2e91b.js" rel="preload" as="script"><link href="/js/chunk-vendors.e76667cc.js" rel="preload" as="script"><link href="/css/chunk-vendors.a179896c.css" rel="stylesheet"><link href="/css/app.2d6b9bb1.css" rel="stylesheet"><link rel="icon" type="image/png" sizes="32x32" href="/img/icons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/icons/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#1A73E8"><meta name="apple-mobile-web-app-capable" content="no"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="apple-mobile-web-app-title" content="Aquariuslt Blog"><link rel="apple-touch-icon" href="/img/icons/apple-touch-icon-152x152.png"><link rel="mask-icon" href="/img/icons/safari-pinned-tab.svg" color="#1A73E8"><meta name="msapplication-TileImage" content="/img/icons/msapplication-icon-144x144.png"><meta name="msapplication-TileColor" content="#000000"><link rel="stylesheet" type="text/css" href="/css/detail.550d548d.css"><script charset="utf-8" src="/js/detail.6094b501.js"></script><meta data-vue-meta="1" name="og:site_name" content="Aquariuslt Blog"><meta data-vue-meta="1" name="og:type" content="website"><meta data-vue-meta="1" name="og:title" content="Spring 整合 Apache Shiro 实现各等级的权限管理"><meta data-vue-meta="1" name="og:description" content="前几个月在做一个常规的权限隔离功能的时候,恰好使用过 Apache Shiro. Apache Shiro 是一款 Java 的安全框架,通常用作 Web 应用的权限校验,身份验证.Apache Shiro is a powerful and easy-to-use Java security framework that performs authentication, authorization, cryptography, and session management. With Shiro’s easy-to-understand API, you can quickly and easily secure any application – from the smallest mobile applications to the largest web and enterprise applications.
"><meta data-vue-meta="1" name="og:image" content="./cover.png"><meta data-vue-meta="1" name="og:type" content="article"><script data-vue-meta="1" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://blog.aquariuslt.com","name":"Aquariuslt Blog","position":1},{"@type":"ListItem","item":"https://blog.aquariuslt.com/posts","name":"Posts","position":2},{"@type":"ListItem","item":"https://blog.aquariuslt.com/posts/2015/10/25/apache-shiro-spring-integration","name":"Spring 整合 Apache Shiro 实现各等级的权限管理","position":3}]}</script><script id="embed-disqus" data-timestamp="1571635224116" type="text/javascript" async="" src="//aquariuslt.disqus.com/embed.js"></script><link rel="prefetch" as="style" href="https://c.disquscdn.com/next/embed/styles/lounge.953a2bd009935f47a8e815c3ee2bfc5a.css"><link rel="prefetch" as="script" href="https://c.disquscdn.com/next/embed/common.bundle.bdf2715fe3d262793670748c6697b1f3.js"><link rel="prefetch" as="script" href="https://c.disquscdn.com/next/embed/lounge.bundle.df4113f81691d4ed6cccc5b74c6c17e8.js"><link rel="prefetch" as="script" href="https://disqus.com/next/config.js"><script src="https://c.disquscdn.com/next/embed/alfalfalfa.0823c767a3bc925f628afd9bed26c958.js" async="" charset="UTF-8"></script></head><body><div data-v-18dadf06="" id="app"><div data-v-18dadf06="" class="md-app md-app-side-drawer md-layout-row md-waterfall md-fixed md-theme-default"><div data-v-18dadf06="" class="md-drawer md-app-drawer md-theme-default md-left md-temporary"><div data-v-ac1b82fe="" data-v-18dadf06="" class="profile"><div data-v-ac1b82fe="" class="md-card md-theme-default"><div data-v-ac1b82fe="" class="md-card-header"><div data-v-ac1b82fe="" class="md-avatar md-theme-default"><img data-v-ac1b82fe="" src="https://img.aquariuslt.com/social/avator.png" alt="Avatar"></div><div data-v-ac1b82fe="" class="md-title">Aquariuslt</div><div data-v-ac1b82fe="" class="md-subhead">superaquariuslt@gmail.com</div></div></div></div><ul data-v-18dadf06="" class="md-list md-theme-default"><li data-v-18dadf06="" to="/" exact="" class="md-list-item"><a data-v-18dadf06="" href="/" class="md-list-item-router md-list-item-container md-button-clean" mdripple="true"><div class="md-list-item-content md-ripple"><i data-v-18dadf06="" class="mdi mdi-24px mdi-home"></i><span data-v-18dadf06="" class="md-list-item-text">Home</span> </div></a></li><li data-v-18dadf06="" to="/categories" exact="" class="md-list-item"><a data-v-18dadf06="" href="/categories" class="md-list-item-router md-list-item-container md-button-clean" mdripple="true"><div class="md-list-item-content md-ripple"><i data-v-18dadf06="" class="mdi mdi-24px mdi-shape"></i><span data-v-18dadf06="" class="md-list-item-text">Categories</span> </div></a></li><li data-v-18dadf06="" to="/tags" exact="" class="md-list-item"><a data-v-18dadf06="" href="/tags" class="md-list-item-router md-list-item-container md-button-clean" mdripple="true"><div class="md-list-item-content md-ripple"><i data-v-18dadf06="" class="mdi mdi-24px mdi-bookmark"></i><span data-v-18dadf06="" class="md-list-item-text">Tags</span> </div></a></li></ul> </div>  <main class="md-app-container md-flex md-layout-column md-theme-default md-scrollbar" style="padding-left: 0px;"><div data-v-18dadf06="" class="md-toolbar md-app-toolbar md-primary md-theme-default md-elevation-2 md-no-elevation" md-elevation="2" style="top: 0px;"><div data-v-18dadf06="" class="md-toolbar-row"><button data-v-18dadf06="" type="button" class="md-button md-icon-button md-theme-default" aria-label="menu"><div class="md-ripple"><div class="md-button-content"><i data-v-18dadf06="" class="mdi mdi-24px mdi-menu"></i></div> </div></button><span data-v-18dadf06="" class="md-title app-title">Spring 整合 Apache Shiro 实现各等级的权限管理 | Aquariuslt Blog</span></div></div> <div class="md-app-scroller md-layout-column md-flex md-theme-default md-scrollbar"><div data-v-18dadf06="" class="md-content md-app-content md-flex md-theme-default"><div data-v-590589f6="" data-v-18dadf06="" class="detail md-layout md-gutter md-alignment-top-center"><div data-v-46cb6cfe="" data-v-590589f6="" class="md-layout md-gutter md-alignment-top-center md-layout-item md-size-100"><div data-v-46cb6cfe="" class="breadcrumbs"><span data-v-46cb6cfe=""><a data-v-46cb6cfe="" href="/" class="breadcrumbs-item"> Aquariuslt Blog</a><span data-v-46cb6cfe="">&gt;</span></span><span data-v-46cb6cfe=""><a data-v-46cb6cfe="" href="/posts" class="breadcrumbs-item"> Posts</a><span data-v-46cb6cfe="">&gt;</span></span><span data-v-46cb6cfe=""><a data-v-46cb6cfe="" href="/posts/2015/10/25/apache-shiro-spring-integration" class="breadcrumbs-item router-link-exact-active router-link-active"> Spring 整合 Apache Shiro 实现各等级的权限管理</a><!----></span></div></div><div data-v-48e13d92="" data-v-590589f6="" class="md-layout md-gutter md-alignment-top-center md-layout-item md-size-100"><div data-v-48e13d92="" class="md-card article-detail md-theme-default"><div data-v-48e13d92="" class="md-card-media article-cover"><img data-v-48e13d92="" src="/posts/2015/10/25/apache-shiro-spring-integration/cover.png" alt="cover"></div><div data-v-48e13d92="" class="md-card-content markdown-body"><h1>Spring 整合 Apache Shiro 实现各等级的权限管理</h1>
<h2>Background</h2>
<p>前几个月在做一个常规的权限隔离功能的时候,恰好使用过 Apache Shiro. Apache Shiro 是一款 Java 的安全框架,通常用作 Web 应用的权限校验,身份验证.</p>
<blockquote>
<p>Apache Shiro is a powerful and easy-to-use Java security framework that performs authentication, authorization, cryptography, and session management. With Shiro’s easy-to-understand API, you can quickly and easily secure any application – from the smallest mobile applications to the largest web and enterprise applications.</p>
</blockquote>
<p>在参考过 IBM 开发社区关于 Shiro 的博客 一篇文章 <a href="https://www.ibm.com/developerworks/cn/java/j-lo-shiro/">在 Web 项目中应用 Apache Shiro</a> 与开涛博客的一个跟我学 Shiro 系列文章 <a href="https://jinnianshilongnian.iteye.com/blog/2024723">开涛博客-跟我学 Shiro</a></p>
<blockquote>
<p>不得不说的是 IBM Developer 社区的文章一向属于生动易懂. 但是上面的这篇讲得并没有之前推荐的讲 Spring-DataJPA 的那篇文章那样浅显, 于是才有了现在这份笔记</p>
</blockquote>
<h2>权限控制</h2>
<p>我所接触到的权限控制大概可以分成两个级别 URL 和方法级别.</p>
<p>以常见的论坛用户来举例.论坛用户简要的分成两种 管理员<code>Admin</code>,普通用户<code>Normal</code>. 其中管理员能够进入用户管理,帖子管理的页面进行 CRUD 操作. 普通用户则只能进行自己帖子的 CRU 操作,以及顶贴什么的.</p>
<p>如果只进行 URL 级别的拦截,只需要在每一个 URL 的访问时 获取用户的角色是<code>Admin</code>还是<code>Normal</code>即可.</p>
<p>如果是进行方法级别的拦截,则可能根据功能的设计衍生出很多设计方案(一眼就能想到的大概是树状,平行等). 但是由于跟数据库的设计密切相关,所以这个级别不细讲. 言归正传(不知道是不是看 light 大大博客看多了,语气有点奇怪),下面结合上面的论坛用户的一个场景进行逻辑与代码的讲解</p>
<h3>URL 级别的权限控制</h3>
<h4>业务场景假设</h4>
<p>首先,我们假设有以下几种种 URL</p>
<pre><code>/user/create        //用户创建,Admin专属
/post/create        //发帖 Admin,Normal共有
/login              //登陆
/logout             //注销
</code></pre>
<h4>Shiro 基本配置</h4>
<h5>Maven</h5>
<p><code>$&lt;shiro.version&gt;</code>请自行替换成当前的最新版本</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${shiro.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-spring<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${shiro.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${shiro.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-ehcache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${shiro.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h5>web.xml</h5>
<p>为了实现与 Spring 同一个级别的 URL 拦截,需要将 Shiro 的 Filter 配置在 Spring MVC 的 Dispatcher Servlet 同一个级别</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>shiroFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>targetFilterLifecycle<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">init-param</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>shiroFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span>
</code></pre>
<h5>Spring ApplicationContext.xml</h5>
<p>在与 Spring 进行整合的时候,为了方便拼切配置,在 Spring 里面导入另一份专用于 Shiro 的 xml 配置</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">import</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">"config/security/applicationContext-shiro-captcha.xml"</span>/&gt;</span>
</code></pre>
<h5>Spring applicationContext-shiro-captcha.xml</h5>
<p>先将整个 shiro 的 xml 配置贴出来,接下来在逐一解说其内容</p>
<pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"<a class="vglnk" href="https://www.springframework.org/schema/beans" rel="nofollow"><span>https</span><span>://</span><span>www</span><span>.</span><span>springframework</span><span>.</span><span>org</span><span>/</span><span>schema</span><span>/</span><span>beans</span></a>"</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"<a class="vglnk" href="https://www.w3.org/2001/XMLSchema-instance" rel="nofollow"><span>https</span><span>://</span><span>www</span><span>.</span><span>w3</span><span>.</span><span>org</span><span>/</span><span>2001</span><span>/</span><span>XMLSchema</span><span>-</span><span>instance</span></a>"</span>
       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"<a class="vglnk" href="https://www.springframework.org/schema/beans" rel="nofollow"><span>https</span><span>://</span><span>www</span><span>.</span><span>springframework</span><span>.</span><span>org</span><span>/</span><span>schema</span><span>/</span><span>beans</span></a> <a class="vglnk" href="https://www.springframework.org/schema/beans/spring-beans-3.1.xsd" rel="nofollow"><span>https</span><span>://</span><span>www</span><span>.</span><span>springframework</span><span>.</span><span>org</span><span>/</span><span>schema</span><span>/</span><span>beans</span><span>/</span><span>spring</span><span>-</span><span>beans</span><span>-</span><span>3</span><span>.</span><span>1</span><span>.</span><span>xsd</span></a>"</span>
       <span class="hljs-attr">default-lazy-init</span>=<span class="hljs-string">"true"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Shiro安全配置<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Shiro's main business-tier object for web-enabled applications --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"securityManager"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.apache.shiro.web.mgt.DefaultWebSecurityManager"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"realm"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"shiroRealm"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"cacheManager"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"shiroEhcacheManager"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 項目自定义的Realm --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"shiroRealm"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.quariuslt.service.security.BookingShiroRealm"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"loginSessionService"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"loginSessionService"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"userService"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"userService"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"cacheManager"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"shiroEhcacheManager"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 用户授权信息Cache, 采用EhCache --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"shiroEhcacheManager"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.apache.shiro.cache.ehcache.EhCacheManager"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"cacheManagerConfigFile"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"classpath:config/security/ehcache-shiro.xml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 保证实现了Shiro内部lifecycle函数的bean执行 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lifecycleBeanPostProcessor"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.apache.shiro.spring.LifecycleBeanPostProcessor"</span>/&gt;</span>


    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"securityManager"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"securityManager"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"captchaFilter"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.quariuslt.service.security.CaptchaFormAuthenticationFilter"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"adminPermissionFilter"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.quariuslt.service.security.AdminPermissionFilter"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"normalPermissionFilter"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.quariuslt.service.security.NormalPermissionFilter"</span>/&gt;</span>

    <span class="hljs-comment">&lt;!-- Shiro Filter --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"shiroFilter"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.apache.shiro.spring.web.ShiroFilterFactoryBean"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"securityManager"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"securityManager"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"loginUrl"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"/login"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"successUrl"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"/booking/search"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"unauthorizedUrl"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"/"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"filters"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">map</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"authc"</span> <span class="hljs-attr">value-ref</span>=<span class="hljs-string">"captchaFilter"</span>/&gt;</span>
                <span class="hljs-comment">&lt;!--&lt;entry key="roles[admin]" value-ref="captchaFilter"/&gt;--&gt;</span>
                <span class="hljs-comment">&lt;!--&lt;entry key="roles[normal]" value-ref="captchaFilter"/&gt;--&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">map</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"filterChainDefinitions"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>
                /=authc
                /register = anon
                /forgot =anon
                /login = anon
                /login/action* = anon
                /logout = logout
                /js/** = anon
                /rest/**=anon
                /image/**=anon
                /jawr_loader.js=anon
                /user/create=roles[admin]
                /post/create/**=roles[normal|admin]
                /** =authc
            <span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>
</code></pre>
<h4>配置详解</h4>
<p>首先要理解一件事情,就是 Shiro 的权限控制 源自于 Web.xml 的 Filter,在 Filter 中获取目标 URL 的请求,解析以达到根据请求是否到达下一集 Filter 的作用. 再要理解一件约定大于配置的问题,了解 Shiro 的一些默认配置解说.</p>
<p>在贴出来的<code>shiro-captcha.xml</code>配置代码中:</p>
<pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Shiro Filter --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"shiroFilter"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.apache.shiro.spring.web.ShiroFilterFactoryBean"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"securityManager"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"securityManager"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"loginUrl"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"/login"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"successUrl"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"/booking/search"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"unauthorizedUrl"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"/"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"filters"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">map</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"authc"</span> <span class="hljs-attr">value-ref</span>=<span class="hljs-string">"captchaFilter"</span>/&gt;</span>
            <span class="hljs-comment">&lt;!--&lt;entry key="roles[admin]" value-ref="captchaFilter"/&gt;--&gt;</span>
            <span class="hljs-comment">&lt;!--&lt;entry key="roles[normal]" value-ref="captchaFilter"/&gt;--&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">map</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"filterChainDefinitions"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>
            /=authc
            /register = anon
            /forgot =anon
            /login = anon
            /login/action* = anon
            /logout = logout
            /js/** = anon
            /rest/**=anon
            /image/**=anon
            /jawr_loader.js=anon
            /user/create=roles[admin]
            /post/create/**=roles[normal|admin]
            /** =authc
        <span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
</code></pre>
<p>先来看<code>&lt;property name="filterChainDefinitions"&gt;</code>中的属性. &lt;values&gt;的内容,其实是 url 对应权限的一些 mapping.表示对应的 url mapping 需要对应的权限. 其中<code>authc</code>,<code>anon</code>,<code>logout</code>样例中提及的这三个,是 Shiro 自己的默认配置</p>
<blockquote>
<p><code>authc</code>表示,这这个 mapping 代表的 url 需要登陆之后才能查看 <code>anon</code>表示,这个 mapping 代表的 url 全部放行,所以可以看到所有 js 文件与 image 文件都被放行了 <code>logout</code> 表示这个 mapping 代表的 url 将进行一次注销操作,在浏览器客户端进行的是 session 的注销,在服务器端则是进行缓存的删除</p>
</blockquote>
<p>其中 <code>roles[admin],roles[normal|admin]</code> 则是自己定义的过滤规则. 表示<code>/user/create</code>只有角色包含<code>admin</code>的有权限访问且<code>/post/create</code>则是角色是<code>admin</code>或<code>normal</code>的有权限访问</p>
<h5>登录与注销</h5>
<h6>登录</h6>
<p>对于所有需要登录的 URL 可以通过 <code>authc</code>一个拦截器来拦截在未登录的状态下,所有所有需要登录的 URL 都是自动跳转到上面 XML 所配置的<code>loginUrl</code>之中. 当然这里返回的是 一个对 <code>/login</code>路径的 get 请求</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"loginUrl"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"/login"</span>/&gt;</span>
</code></pre>
<h6>注销</h6>
<p>注销也很简单,只要任意 url 能够跳转到<code>/logout</code>,便会自动注销.</p>
<h5>同步登录与异步登陆</h5>
<p>其实在 Shiro 的配置中,通过阅读源码可以看出,其实<code>loginUrl</code>一个属性,代表的是当 Method=Get 的请求到达其值对应的 url(/login)时,返回登录的页面. 当 Method=Post 的请求到达其值对应的 url(/login)时,进入到的就是 Shiro 本身的登陆操作该操作,通过读取<code>securityManager</code>的配置,</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"securityManager"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"securityManager"</span>/&gt;</span>
</code></pre>
<p>通过自定义的 realm <code>BookingShiroRealm</code></p>
<blockquote>
<p>此处<code>BookingShiroRealm</code>是自己定义的名称,只是为了符合但是的业务需要起的名字</p>
</blockquote>
<pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Shiro's main business-tier object for web-enabled applications --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"securityManager"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.apache.shiro.web.mgt.DefaultWebSecurityManager"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"realm"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"shiroRealm"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"cacheManager"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"shiroEhcacheManager"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 項目自定义的Realm --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"shiroRealm"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.quariuslt.service.security.BookingShiroRealm"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"loginSessionService"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"loginSessionService"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"userService"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"userService"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"cacheManager"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"shiroEhcacheManager"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
</code></pre>
<p>接下来解说一下 <code>BookingShiroRealm.java</code> 的内容</p>
<pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookingShiroRealm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthorizingRealm</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String LOGIN_SESSION_NAME=<span class="hljs-string">"loginSession"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SIMPLE_AUTHORIZATION_INFO=<span class="hljs-string">"simpleAuthorizationInfo"</span>;

    <span class="hljs-keyword">private</span> LoginSessionService loginSessionService;

    <span class="hljs-keyword">private</span> UserService userService;


    <span class="hljs-function"><span class="hljs-keyword">public</span> LoginSessionService <span class="hljs-title">getLoginSessionService</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> loginSessionService;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setLoginSessionService</span><span class="hljs-params">(LoginSessionService loginSessionService)</span> </span>{
        <span class="hljs-keyword">this</span>.loginSessionService = loginSessionService;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> UserService <span class="hljs-title">getUserService</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> userService;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUserService</span><span class="hljs-params">(UserService userService)</span> </span>{
        <span class="hljs-keyword">this</span>.userService = userService;
    }

    <span class="hljs-comment">/*授权信息*/</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> AuthorizationInfo <span class="hljs-title">doGetAuthorizationInfo</span><span class="hljs-params">(PrincipalCollection principals)</span> </span>{
        LoginSession loginSession = (LoginSession) principals.fromRealm(getName()).iterator().next();
        <span class="hljs-keyword">if</span>(SecurityUtils.getSubject().getSession().getAttribute(LOGIN_SESSION_NAME)==<span class="hljs-keyword">null</span>){
            SecurityUtils.getSubject().getSession().setAttribute(LOGIN_SESSION_NAME, loginSession);
        }
        <span class="hljs-keyword">if</span>(SecurityUtils.getSubject().getSession().getAttribute(SIMPLE_AUTHORIZATION_INFO)==<span class="hljs-keyword">null</span>){

            UserDto userDto=userService.findUserById(loginSession.getUserId());
            <span class="hljs-keyword">if</span> (userDto != <span class="hljs-keyword">null</span>) {
                SimpleAuthorizationInfo info = <span class="hljs-keyword">new</span> SimpleAuthorizationInfo();
                Set&lt;RoleDto&gt; roleDtoSet=userService.getUserRolesByUserId(userDto.getId());
                <span class="hljs-keyword">for</span>(RoleDto roleDto:roleDtoSet){
                    info.addRole(roleDto.getName().toLowerCase());
                }

                SecurityUtils.getSubject().getSession().setAttribute(SIMPLE_AUTHORIZATION_INFO, info);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
            }
        }
        <span class="hljs-keyword">return</span> (AuthorizationInfo)SecurityUtils.getSubject().getSession().getAttribute(SIMPLE_AUTHORIZATION_INFO);
    }

    <span class="hljs-comment">/*认证信息*/</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> AuthenticationInfo <span class="hljs-title">doGetAuthenticationInfo</span><span class="hljs-params">(AuthenticationToken authenticationToken)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>{
        System.out.println(<span class="hljs-string">"Come to BookingShiroRealm"</span>);
        UsernamePasswordToken token=(UsernamePasswordToken)authenticationToken;
        String userId=token.getUsername();
        String cryptedPassword= String.valueOf(token.getPassword());
        <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(userId)){
            UserDto targetUser=userService.getByUserId(userId);
            System.out.println(<span class="hljs-string">"TargetUser:"</span>+userId+<span class="hljs-string">" InputPassWord:"</span>+cryptedPassword+<span class="hljs-string">" DB PassWord:"</span>+targetUser.getCryptedPassword());
            <span class="hljs-keyword">if</span>(cryptedPassword.equals(targetUser.getCryptedPassword())){
                System.out.println(<span class="hljs-string">"BookingShiroRealm:Login Success"</span>);
                LoginSession loginSession=<span class="hljs-keyword">new</span> LoginSession(targetUser.getId(), targetUser.getUserId(),targetUser.getEmail(),SecurityUtils.getSubject().getSession().getHost());
                loginSessionService.clearSessionByUserId(userId);
                loginSessionService.save(loginSession);
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SimpleAuthenticationInfo(loginSession,targetUser.getCryptedPassword().toCharArray(),getName());
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }
}

</code></pre>
<p><code>AuthorizingRealm</code>是 Shiro 负责身份认证的抽象类. 需要实现其<code>doGetAuthenticationInfo</code>方法,实现 对提交过来的用户名/密码 等账号信息,跟数据库进行交互判定登陆是否成功的过程. 和实现其<code>doGetAuthorizationInfo</code>方法,实现对需要登陆之后 对权限的认证.</p>
<p>在说到登陆的校验之前,可以看到在<code>doGetAuthenticationInfo</code>方法里面 有一个 authenticationToken.里面包含了登陆传递过来的用户名和密码信息.这里又是怎么来的呢. 此时返回来回到 Spring 配置 Shiro 的 xml <code>applicationContext-shiro-captcha.xml</code> 会发现</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"filters"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">map</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"authc"</span> <span class="hljs-attr">value-ref</span>=<span class="hljs-string">"captchaFilter"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"roles[admin]"</span> <span class="hljs-attr">value-ref</span>=<span class="hljs-string">"captchaFilter"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"roles[normal]"</span> <span class="hljs-attr">value-ref</span>=<span class="hljs-string">"captchaFilter"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">map</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
</code></pre>
<p>里面会有一个<code>captchaFilter</code>, 指向其注入的类 <code>CaptchaFormAuthenticationFilter.java</code></p>
<p>附上<code>CaptchaFormAuthenticationFilter</code>代码</p>
<pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CaptchaFormAuthenticationFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">FormAuthenticationFilter</span> </span>{

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DEFAULT_CAPTCHA_PARAM = <span class="hljs-string">"captcha"</span>;

    <span class="hljs-keyword">private</span> String captchaParam = DEFAULT_CAPTCHA_PARAM;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getCaptchaParam</span><span class="hljs-params">()</span> </span>{

        <span class="hljs-keyword">return</span> captchaParam;

    }

    <span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">getCaptcha</span><span class="hljs-params">(ServletRequest request)</span> </span>{

        <span class="hljs-keyword">return</span> WebUtils.getCleanParam(request, getCaptchaParam());

    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">onLoginFailure</span><span class="hljs-params">(AuthenticationToken token, AuthenticationException e, ServletRequest request, ServletResponse response)</span> </span>{
        setFailureAttribute(request, e);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFailureAttribute</span><span class="hljs-params">(ServletRequest request, AuthenticationException ae)</span> </span>{
        String className = ae.getClass().getName();
        request.setAttribute(getFailureKeyAttribute(), className);
    }

    <span class="hljs-comment">//这里进行密码的加密</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> CaptchaUsernamePasswordToken <span class="hljs-title">createToken</span><span class="hljs-params">(ServletRequest request, ServletResponse response)</span> </span>{
        System.out.println(<span class="hljs-string">"Come to CreateToken"</span>);
        String username = getUsername(request);
        String password = getPassword(request);
        String captcha = getCaptcha(request);
        <span class="hljs-keyword">boolean</span> rememberMe = isRememberMe(request);
        String host = getHost(request);

        System.out.println(<span class="hljs-string">"Captcha UserName(UserId):"</span> + username);
        System.out.println(<span class="hljs-string">"Captcha Password:"</span> + password);
        System.out.println(<span class="hljs-string">"Captcha RememberMe:"</span> + rememberMe);


        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CaptchaUsernamePasswordToken(username,
                password.toCharArray(), rememberMe, host, captcha);

    }


    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">executeLogin</span><span class="hljs-params">(ServletRequest request, ServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        CaptchaUsernamePasswordToken token = createToken(request, response);

        <span class="hljs-keyword">try</span> {
            System.out.println(<span class="hljs-string">"Execute Login~"</span>);
            Subject subject = getSubject(request, response);
            subject.login(token);

            <span class="hljs-keyword">return</span> onLoginSuccess(token,subject, request, response);
        } <span class="hljs-keyword">catch</span> (AuthenticationException e) {
            <span class="hljs-keyword">return</span> onLoginFailure(token,e, request, response);
        }
    }
}
</code></pre>
<p>继承<code>FormAuthenticationFilter</code>的<code>CaptchaFormAuthenticationFilter</code>并重写其<code>CaptchaUsernamePasswordToken</code>方法. 用于通过<code>/login</code>的 POST 方式提交过来的时候,便会先经过此 filter 的<code>createToken</code>方法进行 token 的生成</p>
<p>假设有一个登陆页面的<code>/login</code>使用同步提交方式,即通过页面的 form 表单,<code>action="/login"</code>,<code>method="POST"</code>提交到后台,触发流程是</p>
<blockquote>
<ol>
<li>到达 <code>FormAuthenticationFilter</code> 根据表单 生成 Token.</li>
<li>调用 Shiro 专门处理认证的 <code>subject</code>其<code>login</code>方法进行登陆</li>
<li><code>login</code>方法 通过调用 自定义的<code>BookingShiroRealm</code>方法所实现的顶级接口 来实现对数据库的信息的读取</li>
<li>判定登陆用户名与密码 匹配之后,可以通过 Shiro 自己配置的缓存保存认证信息.</li>
</ol>
</blockquote>
<p>但是在这个时代,还通过同步登陆 实在是太 TM 捞了,其实异步登陆提交,只需要 手动调用 subject.login 方法即可将第一步到达<code>FormAuthenticationFilter</code>的 token 手动生成</p>
<p>异步登陆的实现代码 大概如下(以 Controller 为例)</p>
<pre><code class="hljs Java"><span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">"/action"</span>, method = RequestMethod.POST,produces = MediaType.APPLICATION_JSON_VALUE)
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> LoginMessage <span class="hljs-title">loginAction</span><span class="hljs-params">(
        @RequestParam(value = <span class="hljs-string">"username"</span>)</span> String username,
        @<span class="hljs-title">RequestParam</span><span class="hljs-params">(value = <span class="hljs-string">"password"</span>)</span> String password,
        @<span class="hljs-title">RequestParam</span><span class="hljs-params">(value = <span class="hljs-string">"rememberMe"</span>, required = <span class="hljs-keyword">false</span>, defaultValue = <span class="hljs-string">"false"</span>)</span> <span class="hljs-keyword">boolean</span> rememberMe,
        ServletRequest request) </span>{
    LoginMessage loginMessage = <span class="hljs-keyword">new</span> LoginMessage(BKGConstants.ActionStatus.FAILURE.getDescription());
    Subject subject = SecurityUtils.getSubject();


    <span class="hljs-comment">//尝试获取 跳转到Login前的那个页面的url</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">null</span> != WebUtils.getSavedRequest(request)) {
        String requestURI= WebUtils.getSavedRequest(request).getRequestURI();
        loginMessage.setRedirect(requestURI);
    }

    <span class="hljs-keyword">try</span> {
        String salt=userService.getByUserId(username).getSalt();
        UsernamePasswordToken token = <span class="hljs-keyword">new</span> UsernamePasswordToken(username, EncryptUtil.encrypt(password,salt));
        subject.login(token);
        loginMessage.setStatus(BKGConstants.ActionStatus.SUCCESS.getDescription());

        <span class="hljs-comment">//尝试判断 用户是不是第一次登陆</span>
        UserDto currentUser=userService.getByUserId(username);
        <span class="hljs-keyword">if</span> (currentUser.getActive().equals(BKGConstants.UserAccountStatus.FIRST_LOGIN.getIndex())){
            String redirectPath=request.getServletContext().getContextPath()+<span class="hljs-string">"/user/password/reset"</span>;
            loginMessage.setRedirect(redirectPath);
        }


    } <span class="hljs-keyword">catch</span> (UnknownAccountException e) {
        loginMessage.setMessage(BKGConstants.LoginFailureMessage.PASSWORD_WRONG.getDescription());
    } <span class="hljs-keyword">catch</span> (IncorrectCredentialsException |NullPointerException e) {
        loginMessage.setMessage(BKGConstants.LoginFailureMessage.USER_NOT_EXIST.getDescription());
    } <span class="hljs-keyword">catch</span> (AuthenticationException e) {
        loginMessage.setMessage(BKGConstants.LoginFailureMessage.ACCOUNT_LOCK.getDescription());
    }
    <span class="hljs-keyword">return</span> loginMessage;
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginMessage</span> </span>{
    <span class="hljs-keyword">private</span> String status;
    <span class="hljs-keyword">private</span> String message;
    <span class="hljs-keyword">private</span> String redirect;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LoginMessage</span><span class="hljs-params">(String status)</span> </span>{
        <span class="hljs-keyword">this</span>.status = status;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getStatus</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> status;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setStatus</span><span class="hljs-params">(String status)</span> </span>{
        <span class="hljs-keyword">this</span>.status = status;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> message;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setMessage</span><span class="hljs-params">(String message)</span> </span>{
        <span class="hljs-keyword">this</span>.message = message;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getRedirect</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> redirect;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setRedirect</span><span class="hljs-params">(String redirect)</span> </span>{
        <span class="hljs-keyword">this</span>.redirect = redirect;
    }
}
</code></pre>
<h5>角色校验</h5>
<p>登陆的时候,其实只是实现了 <code>登陆认证</code>,<code>缓存登录信息</code>的过程. 并没有实现,<code>权限赋予</code>的过程.只有第一次遇到 需要登陆且特定权限的 url 的时候,才会请求后台是否有进入对应 url 的权限.</p>
<p>在讲权限之前,概括一下数据库的设计</p>
<pre><code class="hljs SQL"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">USERS</span>
(
    <span class="hljs-keyword">ID</span> <span class="hljs-built_in">BIGINT</span> PRIMARY <span class="hljs-keyword">KEY</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT,
    ACTIVE <span class="hljs-built_in">BIT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    ADDRESS <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">300</span>),
    CITY <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    COMPANY <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    COUNTRY <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    CRYPTED_PASSWORD <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    DEPARTMENT <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    DISPLAY_NAME <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">128</span>),
    EMAIL <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">60</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    FAX <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    FIRST_NAME <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">40</span>),
    GENDER <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">6</span>),
    JOBTITLE <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    LAST_NAME <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">40</span>),
    LOCATION <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    MIDDLE_NAME <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">40</span>),
    OFFICE <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    OFFICECODE <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">22</span>),
    PHONE <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">128</span>),
    <span class="hljs-keyword">SALT</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    STAFFID <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    STAFFROLE <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">15</span>),
    TERRITORY <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    USERID <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
);


<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">ROLES</span>
(
    <span class="hljs-keyword">ID</span> <span class="hljs-built_in">BIGINT</span> PRIMARY <span class="hljs-keyword">KEY</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT,
    DESCRIPTION <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    <span class="hljs-keyword">NAME</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">INDEX</span> UK_OFX66KERUAPI6VYQPV6F2OR37 <span class="hljs-keyword">ON</span> <span class="hljs-keyword">ROLES</span> (<span class="hljs-keyword">NAME</span>);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> ROLE_USER
(
    ROLE_ID <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    USER_ID <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    PRIMARY <span class="hljs-keyword">KEY</span> (ROLE_ID, USER_ID),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (ROLE_ID) <span class="hljs-keyword">REFERENCES</span> <span class="hljs-keyword">ROLES</span> (<span class="hljs-keyword">ID</span>),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (USER_ID) <span class="hljs-keyword">REFERENCES</span> <span class="hljs-keyword">USERS</span> (<span class="hljs-keyword">ID</span>)
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> FK_NJAJEL6A2Q8TR36EMB9L8VW7N <span class="hljs-keyword">ON</span> ROLE_USER (USER_ID);

</code></pre>
<p>数据库有三个表 <code>USERS</code>,<code>ROLES</code>,<code>USER_ROLE</code> 其实在设计上<code>User</code>表跟<code>ROLE</code>表是多对多的关系,即 User 里面有一个 Set&lt;Role&gt;,Role 里面也有一个 Set&lt;User&gt; 通过中间表<code>USER_ROLE</code>来实现多对多关联.</p>
<p>下面来看 身份认证的具体实现 <code>BookingShiroRealm.java</code></p>
<pre><code class="hljs Java"><span class="hljs-function"><span class="hljs-keyword">protected</span> AuthorizationInfo <span class="hljs-title">doGetAuthorizationInfo</span><span class="hljs-params">(PrincipalCollection principals)</span> </span>{
    LoginSession loginSession = (LoginSession) principals.fromRealm(getName()).iterator().next();
    <span class="hljs-keyword">if</span>(SecurityUtils.getSubject().getSession().getAttribute(LOGIN_SESSION_NAME)==<span class="hljs-keyword">null</span>){
        SecurityUtils.getSubject().getSession().setAttribute(LOGIN_SESSION_NAME, loginSession);
    }
    <span class="hljs-keyword">if</span>(SecurityUtils.getSubject().getSession().getAttribute(SIMPLE_AUTHORIZATION_INFO)==<span class="hljs-keyword">null</span>){

        UserDto userDto=userService.findUserById(loginSession.getUserId());
        <span class="hljs-keyword">if</span> (userDto != <span class="hljs-keyword">null</span>) {
            SimpleAuthorizationInfo info = <span class="hljs-keyword">new</span> SimpleAuthorizationInfo();
            Set&lt;RoleDto&gt; roleDtoSet=userService.getUserRolesByUserId(userDto.getId());
            <span class="hljs-keyword">for</span>(RoleDto roleDto:roleDtoSet){
                info.addRole(roleDto.getName().toLowerCase());
            }

            SecurityUtils.getSubject().getSession().setAttribute(SIMPLE_AUTHORIZATION_INFO, info);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        }
    }
    <span class="hljs-keyword">return</span> (AuthorizationInfo)SecurityUtils.getSubject().getSession().getAttribute(SIMPLE_AUTHORIZATION_INFO);
}
</code></pre>
<p>通过</p>
<pre><code class="hljs Java">Subject.getSession().setAttribute(SIMPLE_AUTHORIZATION_INFO,info)
</code></pre>
<p>来实现一个 根据通过已经登陆的用户,获取其在数据库中所具有的角色的名字的集合 生成字符串,然后存在 Session 里面. 当需要对应的权限,且发现已经有<code>SIMPLE_AUTHORIZATION_INFO</code>这个属性,则根据属性中是否含有对应字符串的来判定是否有对应权限.</p>
<p>当然 对应权限的获取,也是通过 shiro 配置里面的 captchaFilter 的具体实现类,实现其<code>isAccessAllowed</code>方法来判定.</p>
<h2>Summary</h2>
<p>本次主要分享了 Share 如何在 Spring 中整合 Apache Shiro 的过程. 但是整体配置依然是通过 XML 统一配置,其实 Shiro 在近期的版本已经有了 Annotation 级别的方法能够方便的对 URL 的 Mapping 进行注解. 具体的应用过程,就像 Spring 2.X 升级到 3.X 的过程一样,但是由于没有实战,不便多说.</p>
</div><div data-v-48e13d92="" class="md-card-content"><div data-v-15189bc8="" data-v-48e13d92="" tabindex="0" class="md-chip md-theme-default md-clickable"><div class="md-ripple"><span data-v-15189bc8="" class=""> Spring </span> </div> <!----></div><div data-v-15189bc8="" data-v-48e13d92="" tabindex="0" class="md-chip md-theme-default md-clickable"><div class="md-ripple"><span data-v-15189bc8="" class=""> Security </span> </div> <!----></div><div data-v-15189bc8="" data-v-48e13d92="" tabindex="0" class="md-chip md-theme-default md-clickable"><div class="md-ripple"><span data-v-15189bc8="" class=""> Shiro </span> </div> <!----></div><div data-v-15189bc8="" data-v-48e13d92="" tabindex="0" class="md-chip md-theme-default md-clickable"><div class="md-ripple"><span data-v-15189bc8="" class=""> Java </span> </div> <!----></div></div><div data-v-48e13d92="" class="md-card-content"><div data-v-7fa946ff="" data-v-48e13d92="" class="comment"><div data-v-7fa946ff="" id="disqus_thread"><iframe id="dsq-app1424" name="dsq-app1424" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="https://disqus.com/embed/comments/?base=default&amp;f=aquariuslt&amp;t_i=-posts-2015-10-25-apache-shiro-spring-integration&amp;t_u=https%3A%2F%2Fblog.aquariuslt.com%2Fposts%2F2015%2F10%2F25%2Fapache-shiro-spring-integration&amp;t_d=Spring%20%E6%95%B4%E5%90%88%20Apache%20Shiro%20%E5%AE%9E%E7%8E%B0%E5%90%84%E7%AD%89%E7%BA%A7%E7%9A%84%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86&amp;t_t=Spring%20%E6%95%B4%E5%90%88%20Apache%20Shiro%20%E5%AE%9E%E7%8E%B0%E5%90%84%E7%AD%89%E7%BA%A7%E7%9A%84%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86&amp;s_o=default#version=f274d4b819b5f36115bcd7094ebe0b59" style="width: 1px !important; min-width: 100% !important; border: none !important; overflow: hidden !important; height: 395px !important;" horizontalscrolling="no" verticalscrolling="no"></iframe></div></div></div></div></div></div></div></div></main> <!----></div></div><script src="/service-worker.js"></script><script type="text/javascript" src="/js/chunk-vendors.e76667cc.js"></script><script type="text/javascript" src="/js/app.15b2e91b.js"></script><iframe style="display: none;"></iframe></body>